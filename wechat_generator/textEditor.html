<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>文本编辑器</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
    <style>
        .rich-text-editor {
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            min-height: 300px;
            max-height: 100dvh;
            overflow-y: auto;
            padding: 1rem;
            background-color: #fff;
        }
        .rich-text-editor:focus {
            border-color: #86b7fe;
            outline: 0;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        .toolbar {
            border: 1px solid #ced4da;
            border-bottom: none;
            border-radius: 0.375rem 0.375rem 0 0;
            padding: 0.5rem;
            background-color: #f8f9fa;
        }
        .toolbar button {
            margin-right: 0.25rem;
            margin-bottom: 0.25rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="col-12">
            <div class="row">
                <div class="col-lg-8 py-3">
                    <div class="">
                        <div class="row">
                            <div class="col-12">
                                <a href="./listing.html" class="btn btn-primary">← 回到目录</a>
                                <button type="button" class="btn btn-primary" onclick="saveData()">保存记录</button>
                            </div>
                        </div>
                    </div>
                    <div class="card p-4 mt-4">
                        <h4 class="mb-4">文本设定</h4>
                        <div class="row">
                            <div class="col-lg-8 col-xl-6">
                                <div class="form-group mb-3">
                                    <label>标题</label>
                                    <input type="text" class="form-control" id="genTitle" placeholder="标题">
                                </div>
                                <div class="form-group mb-3">
                                    <label>作者</label>
                                    <input type="text" class="form-control" id="author" placeholder="作者名称">
                                </div>
                                <div class="form-group mb-3">
                                    <label>下个章节</label>
                                    <select class="form-control" id="nextChapter">
                                        <option value="">选择下个章节...</option>
                                    </select>
                                </div>
                                <div class="form-group mb-3">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="textOnly">
                                        <label class="form-check-label" for="textOnly">
                                            仅文字
                                        </label>
                                    </div>
                                    <button type="button" class="btn btn-success" onclick="generateImage()">生成图片</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card p-4 mt-4">
                        <h4 class="mb-4">文本内容</h4>
                        <div class="row">
                            <div class="col-12">
                                <div class="toolbar">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('bold')" title="粗体">
                                        <strong>B</strong>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('italic')" title="斜体">
                                        <em>I</em>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('underline')" title="下划线">
                                        <u>U</u>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('insertUnorderedList')" title="无序列表">
                                        • 列表
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('insertOrderedList')" title="有序列表">
                                        1. 列表
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('justifyLeft')" title="左对齐">
                                        ←
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('justifyCenter')" title="居中">
                                        ↔
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="formatText('justifyRight')" title="右对齐">
                                        →
                                    </button>
                                </div>
                                <div class="rich-text-editor" id="textContent" contenteditable="true" placeholder="请输入文本内容...">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="loadingScreen" class="loadingScreen">
        <div>
            <div class="lds-ellipsis"><div></div><div></div><div></div><div></div></div>
            <div>Uploading ...</div>
        </div>
    </div>

    <div id="imageModal" class="modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">生成图片</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body modal-img" id="generatedImg">
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
          </div>
        </div>
    </div>

    <script src="jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="html2canvas.min.js"></script>
    <script>
        const API_KEY = 'pateT1OAqdJjqETzj.f0c16960c0ba5712c854aa6613dfa49e1b50172f0921a688f8cb5d27244df71c';
        const BASE_ID = 'appLowyF339uw0g8o';
        const TABLE_NAME = 'Chat';
        const searchParams = new URLSearchParams(window.location.search);
        var id = null;
        var saveNext = "";

        $(document).ready(function(){
            if(searchParams.has('id')) {
                id = searchParams.get('id');
                loadData();
            }
            
            // Load next chapter options
            loadNextChapterOptions();
        });

        function loadData() {
            fetch(
                `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}/${id}`,
                {
                    method: 'GET',
                    headers: {
                        Accept: 'application/json',
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${API_KEY}`,
                    },
                }
            )
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Something went wrong');
                }
            })
            .then(data => {
                let d = data.fields;
                
                $("#genTitle").val(d.genTitle || '');
                $("#author").val(d.author || '');
                
                // Load next chapter selection
                if (d.next?.[0]) {
                    saveNext = d.next[0];
                }
                
                // Load text content from chatList
                if (d.chatList) {
                    const chatList = JSON.parse(d.chatList);
                    if (chatList.length > 0 && chatList[0].content) {
                        document.getElementById('textContent').innerHTML = chatList[0].content;
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function loadNextChapterOptions() {
            fetch(
                `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}?sort[0][field]=genTitle&sort[0][direction]=asc`,
                {
                    method: 'GET',
                    headers: {
                        Accept: 'application/json',
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${API_KEY}`,
                    },
                }
            )
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Something went wrong');
                }
            })
            .then(data => {
                const records = data.records;
                const selectElement = document.getElementById('nextChapter');
                
                // Clear existing options except the first one
                selectElement.innerHTML = '<option value="">选择下个章节...</option>';
                
                // Add options for each record
                records.forEach(record => {
                    const option = document.createElement('option');
                    option.value = record.id;
                    option.textContent = record.fields?.genTitle || '无标题';
                    selectElement.appendChild(option);
                });

                if(saveNext) {
                    $("#nextChapter").val(saveNext);
                }
            })
            .catch(error => {
                console.error('Error loading next chapter options:', error);
            });
        }

        function formatText(command) {
            document.execCommand(command, false, null);
            document.getElementById('textContent').focus();
        }

        function saveData() {
            $("#loadingScreen").css('display', 'flex');
            
            const textContent = document.getElementById('textContent').innerHTML;
            
            let currData = {
                genTitle: $("#genTitle").val() || '新文本',
                type: 'text',
                author: $("#author").val() || '无名',
                chatList: JSON.stringify([{
                    type: 'text',
                    content: textContent
                }]),
                next: $("#nextChapter").val() ? [$("#nextChapter").val()] : []
            };

            if(id) {
                // Update existing record
                fetch(`https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}/${id}`, {
                    method: 'PATCH',
                    headers: {
                        Accept: 'application/json',
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fields: currData
                    })
                }).then(async (record) => {
                    $("#loadingScreen").hide();
                    Swal.fire({
                        title: "编辑成功!",
                        icon: "success"
                    }).then(function() {
                        window.location.replace("./listing.html");
                    });
                })
                .catch(error => {
                    $("#loadingScreen").hide();
                    console.error('Error:', error);
                    Swal.fire({
                        title: "保存失败!",
                        text: "请检查网络连接后重试",
                        icon: "error"
                    });
                });
            } else {
                // Create new record
                fetch(`https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}`, {
                    method: 'POST',
                    headers: {
                        Accept: 'application/json',
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fields: currData
                    })
                }).then(async (record) => {
                    $("#loadingScreen").hide();
                    Swal.fire({
                        title: "添加成功!",
                        icon: "success"
                    }).then(function() {
                        window.location.replace("./listing.html");
                    });
                })
                .catch(error => {
                    $("#loadingScreen").hide();
                    console.error('Error:', error);
                    Swal.fire({
                        title: "保存失败!",
                        text: "请检查网络连接后重试",
                        icon: "error"
                    });
                });
            }
        }

        // Add placeholder functionality
        document.getElementById('textContent').addEventListener('focus', function() {
            if (this.innerHTML === '') {
                this.innerHTML = '';
            }
        });

        document.getElementById('textContent').addEventListener('blur', function() {
            if (this.innerHTML === '') {
                this.innerHTML = '';
            }
        });

        function generateImage() {
            $("#loadingScreen").css('display', 'flex');
            
            // Create a temporary container for the image generation
            const tempContainer = document.createElement('div');
            tempContainer.style.width = '1200px';
            tempContainer.style.backgroundColor = '#ffffff';
            tempContainer.style.padding = '40px';
            tempContainer.style.fontFamily = 'Arial, sans-serif';
            tempContainer.style.lineHeight = '1.6';
            tempContainer.style.color = '#333333';
            
            // Get the content
            const title = $("#genTitle").val() || '无标题';
            const author = $("#author").val() || '无名';
            const textContent = document.getElementById('textContent').innerHTML;
            const textOnly = $("#textOnly").is(":checked");
            
            // Create the HTML structure for the image
            let htmlContent = '';
            
            if (textOnly) {
                // Only show text content with larger font size
                htmlContent = `
                    <div style="font-size: 20px; text-align: left; max-width: 100%;">
                        ${textContent}
                    </div>
                `;
            } else {
                // Show title, author, and text content
                htmlContent = `
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h1 style="font-size: 36px; font-weight: bold; margin-bottom: 10px; color: #2c3e50;">${title}</h1>
                        <p style="font-size: 18px; color: #7f8c8d; margin: 0;">作者: ${author}</p>
                    </div>
                    <div style="font-size: 20px; text-align: left; max-width: 100%;">
                        ${textContent}
                    </div>
                `;
            }
            
            tempContainer.innerHTML = htmlContent;
            
            // Append to body temporarily
            document.body.appendChild(tempContainer);
            
            // Generate the image
            html2canvas(tempContainer, {
                width: 1200,
                height: tempContainer.scrollHeight,
                useCORS: true,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                // Remove the temporary container
                document.body.removeChild(tempContainer);
                
                // Display the generated image
                document.getElementById("generatedImg").innerHTML = "";
                var imgUrl = canvas.toDataURL("image/png");
                var img = document.createElement("img");
                img.src = imgUrl;
                img.style.maxWidth = "100%";
                img.style.height = "auto";
                document.getElementById("generatedImg").appendChild(img);
                
                $("#loadingScreen").hide();
                $("#imageModal").modal('show');
            }).catch(error => {
                // Remove the temporary container in case of error
                if (document.body.contains(tempContainer)) {
                    document.body.removeChild(tempContainer);
                }
                $("#loadingScreen").hide();
                console.error('Error generating image:', error);
                Swal.fire({
                    title: "生成失败!",
                    text: "图片生成失败，请重试",
                    icon: "error"
                });
            });
        }
    </script>
</body>
</html>
