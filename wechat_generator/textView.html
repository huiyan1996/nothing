<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>文本查看</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
    <style>
        .text-content {
            background-color: #fff;
            /* border: 1px solid #dee2e6; */
            border-radius: 0.375rem;
            /* padding: 2rem; */
            min-height: 400px;
            line-height: 1.6;
            font-size: 1.1rem;
        }
        .text-content h1, .text-content h2, .text-content h3, .text-content h4, .text-content h5, .text-content h6 {
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        .text-content p {
            margin-bottom: 1rem;
        }
        .text-content ul, .text-content ol {
            margin-bottom: 1rem;
            padding-left: 2rem;
        }
        .text-content blockquote {
            border-left: 4px solid #dee2e6;
            padding-left: 1rem;
            margin: 1rem 0;
            font-style: italic;
            color: #6c757d;
        }
        .text-content img {
            max-width: 100%;
            height: auto;
            border-radius: 0.375rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-md-10 col-12 py-5">
                <div class="card p-4">
                    <div class="row">
                        <div class="col-12">
                            <h1 id="textTitle" class="mb-3 text-center">加载中...</h1>
                            <div class="text-muted mb-4 text-center">
                                <span class="badge bg-info me-2">文本</span>
                                作者: <span id="textAuthor">加载中...</span>
                            </div>
                            <hr class="my-4">
                            <div class="text-content" id="textContent">
                                <div class="text-center text-muted">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">加载中...</span>
                                    </div>
                                    <div class="mt-2">正在加载文本内容...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const API_KEY = 'pateT1OAqdJjqETzj.f0c16960c0ba5712c854aa6613dfa49e1b50172f0921a688f8cb5d27244df71c';
        const BASE_ID = 'appLowyF339uw0g8o';
        const TABLE_NAME = 'Chat';
        const searchParams = new URLSearchParams(window.location.search);
        var id = null;
        var nextChapterId = null;
        var nextChapterType = null;

        $(document).ready(function(){
            if(searchParams.has('id')) {
                id = searchParams.get('id');
                loadData();
            } else {
                Swal.fire({
                    title: "错误!",
                    text: "缺少记录ID",
                    icon: "error"
                }).then(function() {
                    window.location.replace("./listing.html");
                });
            }
        });

        function loadData() {
            fetch(
                `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}/${id}`,
                {
                    method: 'GET',
                    headers: {
                        Accept: 'application/json',
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${API_KEY}`,
                    },
                }
            )
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Something went wrong');
                }
            })
            .then(data => {
                let d = data.fields;
                
                // Update page title
                document.title = d.genTitle || '文本查看';
                
                // Update header information
                $("#textTitle").text(d.genTitle || '无标题');
                $("#textAuthor").text(d.author || '无名');
                
                // Load next chapter data
                if (d.next && d.next.length > 0) {
                    nextChapterId = d.next[0];
                }
                
                // Load next chapter type
                if (d.nextType && d.nextType.length > 0) {
                    nextChapterType = d.nextType[0];
                }
                
                // Load and display text content
                if (d.chatList) {
                    const chatList = JSON.parse(d.chatList);
                    if (chatList.length > 0 && chatList[0].content) {
                        $("#textContent").html(chatList[0].content);
                        // Add next chapter button if available
                        if (nextChapterId) {
                            addNextChapterButton();
                        }
                    } else {
                        $("#textContent").html('<div class="text-center text-muted">暂无内容</div>');
                    }
                } else {
                    $("#textContent").html('<div class="text-center text-muted">暂无内容</div>');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: "加载失败!",
                    text: "无法加载文本内容，请检查网络连接后重试",
                    icon: "error"
                }).then(function() {
                    window.location.replace("./listing.html");
                });
            });
        }

        function addNextChapterButton() {
            // Determine the correct URL based on next chapter type
            const nextChapterUrl = nextChapterType === 'text' ? 
                `./textView.html?id=${nextChapterId}` : 
                `./viewLive.html?id=${nextChapterId}`;
                
            const nextButton = `
                <div class="text-center mt-4">
                    <a href="${nextChapterUrl}" class="btn btn-link text-decoration-none text-success btn-lg">下一章</a>
                </div>
            `;
            $("#textContent").append(nextButton);
        }
    </script>
</body>
</html>
